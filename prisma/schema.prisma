// Mabel Database Schema
// Based on implementation-plan.md data model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================
// USER & AUTHENTICATION
// ======================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password for email/password auth
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  projects      Project[]
  payments      Payment[]
  jobs          Job[]
  accounts      Account[]
  sessions      Session[]

  @@index([email])
  @@map("users")
}

// NextAuth.js Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// NextAuth.js Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// NextAuth.js Verification Token
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ======================
// PROJECT & STORY
// ======================

enum ProjectStatus {
  DRAFT
  RECORDING_INFO
  QUESTIONS_GENERATED
  AUDIO_UPLOADED
  TRANSCRIBING
  TRANSCRIPTION_COMPLETE
  GENERATING_NARRATIVE
  NARRATIVE_COMPLETE
  COMPLETE
  ERROR

  @@map("project_status")
}

model Project {
  id        String        @id @default(cuid())
  userId    String
  title     String
  status    ProjectStatus @default(DRAFT)

  // Module tracking
  currentModuleNumber   Int     @default(1)
  totalModulesCompleted Int     @default(0)

  // Book compilation
  bookTitle   String?
  bookStatus  String? // "DRAFT", "COMPILING", "COMPLETE"
  compiledBookUrl String?

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  interviewee       Interviewee?
  questions         InterviewQuestion[]
  sessions          InterviewSession[]
  narrative         Narrative?
  jobs              Job[]
  modules           Module[]
  journalEntries    JournalEntry[]

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@map("projects")
}

// ======================
// INTERVIEWEE
// ======================

model Interviewee {
  id         String   @id @default(cuid())
  projectId  String   @unique
  name       String
  relationship String  // "parent", "grandparent", "friend", "other"
  birthYear  Int?
  generation String?  // "Greatest Generation", "Silent", "Boomer", "Gen X", etc.
  topics     Json     // Array of topics: ["childhood", "career", "family"]
  notes      String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("interviewees")
}

// ======================
// MODULES
// ======================

enum ModuleStatus {
  DRAFT                   // Module created, no questions yet
  QUESTIONS_GENERATED     // Questions generated and ready
  IN_PROGRESS            // User answering questions
  GENERATING_CHAPTER     // AI generating chapter
  CHAPTER_GENERATED      // Chapter created, awaiting approval
  APPROVED               // User approved, module complete

  @@map("module_status")
}

model Module {
  id           String       @id @default(cuid())
  projectId    String
  moduleNumber Int          // 1, 2, 3...
  title        String?      // e.g., "Early Childhood", "First Job"
  status       ModuleStatus @default(DRAFT)
  theme        String?      // Optional theme/focus for this module

  // Cover image (AI-generated or uploaded)
  coverImageUrl       String?   // DALL-E URL or S3 URL
  coverImagePrompt    String?   @db.Text // Prompt used to generate the image
  coverImageGeneratedAt DateTime? // When image was generated

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?

  // Relations
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  questions ModuleQuestion[]
  chapters  ModuleChapter[]

  @@unique([projectId, moduleNumber])
  @@index([projectId])
  @@index([projectId, status])
  @@index([projectId, moduleNumber])
  @@map("modules")
}

model ModuleQuestion {
  id       String @id @default(cuid())
  moduleId String
  question String @db.Text
  category String // "Early Life", "Career", "Relationships", etc.
  order    Int

  // User response
  response     String?   @db.Text
  respondedAt  DateTime?

  // Context tracking (for follow-up questions)
  contextSource   String?   // "initial" or "module_1", "module_2", etc.
  contextKeywords String[]  @default([]) // Keywords from previous modules

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([moduleId, order])
  @@map("module_questions")
}

model ModuleChapter {
  id       String @id @default(cuid())
  moduleId String
  content  String @db.Text // The narrative text
  wordCount Int?
  version  Int    @default(1) // 1, 2, 3... (for regenerations)

  // Generation settings
  narrativePerson String? // "first-person" or "third-person"
  narrativeTone   String? // "warm", "formal", "conversational"
  narrativeStyle  String? // "descriptive", "concise", "poetic"

  // Chapter illustration (AI-generated or uploaded)
  illustrationUrl       String?   // DALL-E URL or S3 URL
  illustrationPrompt    String?   @db.Text // Prompt used to generate the image
  illustrationGeneratedAt DateTime? // When image was generated

  // Metadata
  structure Json? // { sections: [{ title, startParagraph }] }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([moduleId, version])
  @@map("module_chapters")
}

// ======================
// INTERVIEW QUESTIONS
// ======================

model InterviewQuestion {
  id               String   @id @default(cuid())
  projectId        String
  question         String   @db.Text
  category         String   // "Early Life", "Career", "Family", etc.
  order            Int
  batch            Int      @default(1) // Tracks which round/batch this question belongs to
  isFollowUp       Boolean  @default(false)
  parentQuestionId String?
  response         String?  @db.Text
  createdAt        DateTime @default(now())

  // Relations
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentQuestion  InterviewQuestion?  @relation("QuestionFollowUps", fields: [parentQuestionId], references: [id], onDelete: SetNull)
  followUpQuestions InterviewQuestion[] @relation("QuestionFollowUps")

  @@index([projectId])
  @@index([projectId, order])
  @@index([projectId, batch])
  @@index([parentQuestionId])
  @@map("interview_questions")
}

// ======================
// INTERVIEW SESSION & TRANSCRIPTION
// ======================

enum SessionStatus {
  UPLOADING
  UPLOADED
  PROCESSING
  COMPLETE
  ERROR

  @@map("session_status")
}

model InterviewSession {
  id            String        @id @default(cuid())
  projectId     String
  audioUrl      String?       // Presigned S3 URL
  audioFileKey  String        // S3 object key
  duration      Int?          // Duration in seconds
  fileSize      Int?          // File size in bytes
  status        SessionStatus @default(UPLOADING)
  uploadedAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  transcription Transcription?

  @@index([projectId])
  @@index([status])
  @@map("interview_sessions")
}

model Transcription {
  id             String   @id @default(cuid())
  sessionId      String   @unique
  text           String   @db.Text
  wordTimings    Json?    // Word-level timestamps for future features
  accuracy       Float?
  speakerLabels  Json?    // For multi-speaker support (Phase 3)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  session InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("transcriptions")
}

// ======================
// NARRATIVE
// ======================

enum NarrativeStatus {
  GENERATING
  DRAFT
  FINAL
  ERROR

  @@map("narrative_status")
}

model Narrative {
  id        String          @id @default(cuid())
  projectId String          @unique
  content   String          @db.Text
  structure Json            // Chapter/section metadata
  version   Int             @default(1)
  status    NarrativeStatus @default(GENERATING)
  wordCount Int?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  audiobook Audiobook?

  @@index([projectId])
  @@index([status])
  @@map("narratives")
}

// ======================
// AUDIOBOOK (Post-MVP)
// ======================

model Audiobook {
  id             String   @id @default(cuid())
  narrativeId    String   @unique
  audioUrl       String?  // Presigned S3 URL
  audioFileKey   String   // S3 object key
  voiceId        String?  // ElevenLabs voice ID
  voiceProvider  String   // "openai" or "elevenlabs"
  duration       Int?     // Duration in seconds
  isVoiceCloned  Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  narrative Narrative @relation(fields: [narrativeId], references: [id], onDelete: Cascade)

  @@index([narrativeId])
  @@map("audiobooks")
}

// ======================
// JOB QUEUE
// ======================

enum JobType {
  TRANSCRIBE_AUDIO
  GENERATE_NARRATIVE
  GENERATE_QUESTIONS
  CREATE_AUDIOBOOK
  SEND_NOTIFICATION

  // Module-specific jobs
  GENERATE_MODULE_QUESTIONS
  GENERATE_MODULE_CHAPTER
  COMPILE_BOOK

  // Journal-specific jobs
  PROCESS_JOURNAL_ENTRY

  @@map("job_type")
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED

  @@map("job_status")
}

model Job {
  id          String    @id @default(cuid())
  projectId   String
  userId      String
  type        JobType
  status      JobStatus @default(PENDING)
  input       Json      // Job input parameters
  output      Json?     // Job output/results
  progress    Int       @default(0)
  error       String?   @db.Text
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([projectId, type, status])
  @@map("jobs")
}

// ======================
// JOURNAL ENTRIES
// ======================

enum JournalEntryStatus {
  RECORDING
  UPLOADED
  PROCESSING
  COMPLETE
  ERROR

  @@map("journal_entry_status")
}

model JournalEntry {
  id             String             @id @default(cuid())
  projectId      String
  entryDate      DateTime           @default(now())
  title          String?            // AI-generated creative title
  audioFileKey   String?            // S3 object key
  rawTranscript  String?            @db.Text
  narrativeText  String?            @db.Text
  promptText     String?            @db.Text // AI prompt shown to user
  status         JournalEntryStatus @default(RECORDING)
  wordCount      Int?
  duration       Int?               // Audio duration in seconds
  errorMessage   String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, entryDate])
  @@index([status])
  @@map("journal_entries")
}

// ======================
// PAYMENTS
// ======================

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED

  @@map("payment_status")
}

model Payment {
  id                    String        @id @default(cuid())
  userId                String
  projectId             String?
  amount                Int           // Amount in cents
  currency              String        @default("usd")
  status                PaymentStatus @default(PENDING)
  stripePaymentIntentId String        @unique
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@map("payments")
}

// ======================
// AUDIT LOG (Optional but recommended)
// ======================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // "PROJECT_CREATED", "DATA_EXPORTED", etc.
  resource   String   // "project", "user_data", etc.
  resourceId String?
  ipAddress  String?
  userAgent  String?  @db.Text
  metadata   Json?
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}
